<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Master PC</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="loading" id="loadingScreen">
  <div class="loading-text">Loading Master PC...</div>
</div>
<div class="app" style="display:none;" id="mainApp">
  <div class="header">
    <div class="title-row">
      <div class="title">
        <span class="dot"></span>
        <span id="appTitle">MASTER PC</span>
        <span class="subtitle" id="appSubtitle">Reality Configuration Console</span>
        <a href="https://github.com/Biohazardry69/MasterPC" target="_blank" rel="noopener" class="github-link" title="View on GitHub">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
          </svg>
        </a>
        <span class="pill" id="currentSubjectPill" style="margin-left:8px;">Subject: <span id="currentSubjectName" class="subject-name">None</span></span>
      </div>
      <div class="right-ops">
        <span class="pill">Awareness:
          <select id="awarenessSelect"></select>
        </span>
        <span class="pill"><label>Auto-Apply</label><input id="autoApply" type="checkbox" /></span>
        <button id="applyBtn" class="warn">Apply Changes</button>
      </div>
    </div>
    <div class="toolbar">
      <div class="block">
        <button id="subjectSearchBtn">Search for subjects</button>
      </div>
      <div class="block">
        <button id="exportBtn" class="secondary">Export Subject</button>
        <button id="importBtn" class="secondary">Import Subject</button>
        <input id="subjectUpload" type="file" accept="application/json" style="display:none" />
        <button id="lockBtn" class="danger">Lock Parameters</button>
        <span id="lockState" class="pill ghost">Unlocked</span>
      </div>
      <div class="block">
        <button id="expandAllBtn" class="mini">Expand All</button>
        <button id="collapseAllBtn" class="mini">Collapse All</button>
      </div>
    </div>
  </div>

  <div class="grid">
    <!-- LEFT: Preview + Commands -->
    <div class="panel">
      <h3>Live Preview</h3>
      <div class="preview" id="preview">
        <div class="subject-badge" id="previewBadge">No Subject</div>
        <img id="previewImg" alt="" style="display:none;" />
        <div class="placeholder" id="previewPh">
          No image loaded.<br/>
          Use the upload below to set a subject portrait.
        </div>
        <div class="mask"></div>
      </div>
      <div class="image-upload-area" id="imageUploadArea">
        <div class="upload-option">
          <label class="upload-label">
            <input id="imgUpload" type="file" accept="image/*" style="display:none;" />
            <button id="imgUploadBtn">Choose File</button>
          </label>
        </div>
        <div class="upload-option">
          <input id="imgUrlInput" type="text" placeholder="Or paste image URL..." style="flex:1;" />
          <button id="imgUrlBtn">Load URL</button>
        </div>
        <button id="clearImgBtn" class="secondary mini">Clear Image</button>
        <div class="note ghost" style="text-align:center;width:100%;margin-top:4px;">Drag & drop an image anywhere on the preview</div>
      </div>

      <h3>Custom Commands</h3>
      <textarea id="customCmd" placeholder='E.g. "set physical.height.cm = 182" or "boost charisma +15%"'></textarea>
      <div class="upload-row">
        <button id="queueCmdBtn">Queue Command</button>
        <span class="note">Commands are added to the Change Queue. With Auto-Apply ON, they apply immediately.</span>
      </div>
    </div>

    <!-- RIGHT: Parameters -->
    <div class="panel">
      <h3>Parameters</h3>
      <div id="paramsPanel" class="params">
        <!-- Built from def.json -->
      </div>
    </div>
  </div>

  <!-- Footer Logs -->
  <div class="footer">
    <div class="log">
      <h4>Change Queue</h4>
      <div id="queueList" class="content"></div>
      <div class="controls">
        <button id="clearQueueBtn">Clear Queue</button>
        <span class="note">Queued changes will be applied with the Apply button unless Auto-Apply is ON.</span>
      </div>
    </div>
    <div class="log">
      <h4>Applied Log</h4>
      <div id="appliedList" class="content"></div>
      <div class="controls">
        <button id="clearAppliedBtn">Clear Log</button>
        <span class="note">Awareness: <span id="awarenessEcho" class="kbd">—</span></span>
      </div>
    </div>
  </div>
</div>

<!-- Subject Search Modal -->
<div id="subjectModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="subjectModalTitle">
  <div class="modal-backdrop"></div>
  <div class="modal-card">
    <div class="modal-header">
      <div class="modal-title" id="subjectModalTitle">Search for Subjects</div>
      <button class="mini" id="modalCloseBtn">✕</button>
    </div>
    <div class="modal-body">
      <div class="radar-area">
        <div class="radar">
          <div class="radar-sweep"></div>
          <div class="radar-grid"></div>
        </div>
      </div>
      <div class="modal-content-grid">
        <div class="modal-section">
          <div class="modal-subtitle">Predefined subjects</div>
          <div class="modal-row">
            <input type="text" id="presetFilter" placeholder="Filter by name..." />
          </div>
          <div id="presetList" class="preset-list"></div>
        </div>
        <div class="modal-section">
          <div class="modal-subtitle">Select or create</div>
          <div class="modal-row">
            <label>Subject name</label>
            <input type="text" id="subjectNameInput" placeholder="Enter a name or pick from list" />
          </div>
          <div class="modal-row">
            <label>New subject mode</label>
            <div class="mode-box">
              <label><input type="radio" name="newMode" value="blank" checked /> Blank parameter set (schema defaults)</label>
              <label><input type="radio" name="newMode" value="preset" /> Start from preset:
                <select id="presetSelect"></select>
              </label>
            </div>
          </div>
          <div class="modal-actions">
            <button id="useSubjectBtn" class="warn">Use This Subject</button>
            <button id="cancelSubjectBtn">Cancel</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer note">
      Tip: You can add your own presets by providing subjects/index.json and JSON files for each subject.
    </div>
  </div>
</div>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

  // Core state
  let SCHEMA = null;
  let currentSubject = null;
  let locked = false;

  // For queue and logs
  const currentParams = new Map(); // id -> value (string/number/array/object)
  const stagedChanges = new Map(); // id -> {from,to,label,unit}
  const appliedLog = []; // items

  // Param registry for schema-driven rendering
  const PARAM_META = new Map(); // id -> { type, label, unit, default, itemRef }
  const KNOWN_IDS = new Set();
  const UNKNOWN_PARAMS = new Map(); // id -> value (from imports that aren't in schema)

  // Predefined subjects (will be loaded from subjects/index.json if present)
  let PRESETS = []; // [{name, file}, ...]
  let SELECTED_PRESET = null;

  const els = {
    loading: $('#loadingScreen'),
    app: $('#mainApp'),

    // header/toolbar
    appTitle: $('#appTitle'),
    appSubtitle: $('#appSubtitle'),
    subjectPill: $('#currentSubjectPill'),
    subjectNameHeader: $('#currentSubjectName'),
    previewBadge: $('#previewBadge'),

    awareness: $('#awarenessSelect'),
    awarenessEcho: $('#awarenessEcho'),
    autoApply: $('#autoApply'),
    applyBtn: $('#applyBtn'),

    subjectSearchBtn: $('#subjectSearchBtn'),
    exportBtn: $('#exportBtn'),
    importBtn: $('#importBtn'),
    subjectUpload: $('#subjectUpload'),

    lockBtn: $('#lockBtn'),
    lockState: $('#lockState'),
    expandAll: $('#expandAllBtn'),
    collapseAll: $('#collapseAllBtn'),

    // left panel
    previewImg: $('#previewImg'),
    previewPh: $('#previewPh'),
    imgUpload: $('#imgUpload'),
    clearImgBtn: $('#clearImgBtn'),

    // params
    paramsPanel: $('#paramsPanel'),

    // logs
    queueList: $('#queueList'),
    appliedList: $('#appliedList'),
    clearQueueBtn: $('#clearQueueBtn'),
    clearAppliedBtn: $('#clearAppliedBtn'),

    // commands
    customCmd: $('#customCmd'),
    queueCmdBtn: $('#queueCmdBtn'),

    // modal
    modal: $('#subjectModal'),
    modalClose: $('#modalCloseBtn'),
    cancelSubjectBtn: $('#cancelSubjectBtn'),
    useSubjectBtn: $('#useSubjectBtn'),
    presetList: $('#presetList'),
    presetFilter: $('#presetFilter'),
    presetSelect: $('#presetSelect'),
    subjectNameInput: $('#subjectNameInput')
  };

  // Boot
  init();

  async function init(){
    try{
      // Load schema
      const res = await fetch('def.json');
      if (!res.ok) throw new Error('Failed to load def.json');
      SCHEMA = await res.json();

      // Meta UI
      applyMeta();

      // Build parameter UI from schema
      buildParameterUI();

      // Build Unrecognized group (empty initially)
      ensureUnrecognizedGroup();

      // Hook controls
      hookToolbar();
      hookParamInputs();
      hookTagInputs();
      hookRepeaters();

      renderQueue();
      renderApplied();
      updateAwarenessEcho();
      updateLockState();

      // Try to load preset index (optional)
      loadPresetIndex();

      // Show app
      els.loading.style.display = 'none';
      els.app.style.display = '';

      // Install size resizers
      installResizers();
    }catch(err){
      console.error(err);
      els.loading.innerHTML = `<div style="color:var(--danger)">Init error: ${err.message}</div>`;
    }
  }

  function applyMeta(){
    const meta = SCHEMA.meta || {};
    els.appTitle.textContent = meta.title || 'Master PC';
    els.appSubtitle.textContent = meta.subtitle || '';

    // Awareness
    const aw = meta.awareness || { options: ['Everyone'], default: 'Everyone' };
    els.awareness.innerHTML = '';
    (aw.options || []).forEach(v=>{
      const op=document.createElement('option');
      op.value=v; op.textContent=v||'—';
      els.awareness.appendChild(op);
    });
    els.awareness.value = aw.default || (aw.options?.[0] || 'Everyone');

    els.autoApply.checked = !!meta.autoApply;

    // Optional UI color overrides
    if (SCHEMA.ui && SCHEMA.ui.colors){
      const root = document.documentElement;
      Object.entries(SCHEMA.ui.colors).forEach(([k,v])=>{
        const varName = '--' + k.replace(/([A-Z])/g,'-$1').toLowerCase();
        root.style.setProperty(varName, v);
      });
    }
  }

  // -------------------- Schema UI Builder --------------------

  function buildParameterUI(){
    els.paramsPanel.innerHTML = '';
    PARAM_META.clear();
    KNOWN_IDS.clear();

    const groups = SCHEMA.parameterGroups || SCHEMA.parameters || [];
    if (!groups.length){
      els.paramsPanel.innerHTML = '<div class="note">No parameters defined in def.json.</div>';
      return;
    }
    groups.forEach(g => els.paramsPanel.appendChild(renderGroup(g)));
  }

  function renderGroup(group){
    const d = document.createElement('details');
    if (group.expanded) d.open = true;
    d.dataset.group = group.id || group.key || '';
    const s = document.createElement('summary');
    s.innerHTML = `<span class="triangle">▶</span> ${escapeHtml(group.label || group.id || '')}`;
    const body = document.createElement('div');
    body.className = 'group-body';

    (group.items || group.children || []).forEach(item=>{
      const el = renderItem(item);
      if (el) body.appendChild(el);
    });

    d.appendChild(s);
    d.appendChild(body);
    return d;
  }

  function renderItem(item){
    switch(item.type){
      case 'group': return renderGroup(item);
      case 'input': return renderInput(item);
      case 'range': return renderRange(item);
      case 'select': return renderSelect(item);
      case 'tags': return renderTags(item);
      case 'repeater': return renderRepeater(item);
      case 'composite': return renderComposite(item);
      default:
        return null;
    }
  }

  function registerParamMeta(id, meta){
    if (!id) return;
    PARAM_META.set(id, meta);
    KNOWN_IDS.add(id);
  }

  function renderInput(item){
    const row = rowTemplate(item.label);
    const input = document.createElement('input');
    input.type = item.inputType || 'text';
    input.className = 'param';
    input.dataset.param = item.id;
    input.dataset.label = item.label || item.id;
    if (item.unit) input.dataset.unit = item.unit;
    if (item.placeholder) input.placeholder = item.placeholder;
    if (item.min !== undefined) input.min = item.min;
    if (item.max !== undefined) input.max = item.max;
    if (item.step !== undefined) input.step = item.step;

    row.control.appendChild(input);
    row.unit.textContent = item.unit || '';

    registerParamMeta(item.id, {type:'input', inputType: input.type, label:item.label, unit:item.unit, default:item.default, itemRef:item});
    return row.row;
  }

  function renderRange(item){
    const row = rowTemplate(item.label);
    const sliderRow = document.createElement('div');
    sliderRow.className = 'slider-row';
    sliderRow.style.gridColumn = 'span 2';

    const input = document.createElement('input');
    input.type = 'range';
    input.className = 'param';
    input.dataset.param = item.id;
    input.dataset.label = item.label || item.id;
    input.min = item.min ?? 0;
    input.max = item.max ?? 100;
    input.step = item.step ?? 1;
    if (item.unit) input.dataset.unit = item.unit;
    sliderRow.appendChild(input);

    if (item.showValue){
      const bubble = document.createElement('div');
      bubble.className = 'value-bubble';
      bubble.textContent = '—';
      sliderRow.appendChild(bubble);
    }
    row.control.replaceWith(sliderRow);
    registerParamMeta(item.id, {type:'range', label:item.label, unit:item.unit, default:item.default, itemRef:item});
    return row.row;
  }

  function renderSelect(item){
    const row = rowTemplate(item.label);
    const select = document.createElement('select');
    select.className = 'param';
    select.dataset.param = item.id;
    select.dataset.label = item.label || item.id;
    (item.options || []).forEach(v=>{
      const op=document.createElement('option');
      op.value = v;
      op.textContent = v || '—';
      select.appendChild(op);
    });
    if (item.default !== undefined) select.value = item.default;
    row.control.appendChild(select);
    registerParamMeta(item.id, {type:'select', label:item.label, unit:'', default:item.default, options:item.options || [], itemRef:item});
    return row.row;
  }

  function renderTags(item){
    const row = rowTemplate(item.label);
    const cont = document.createElement('div');
    cont.className = 'tag-input';
    cont.dataset.param = item.id;
    cont.dataset.label = item.label || item.id;

    const ghost = document.createElement('span');
    ghost.className = 'tag ghost';
    ghost.textContent = item.placeholder || 'Type then Enter';
    cont.appendChild(ghost);

    const input = document.createElement('input');
    input.type = 'text';
    input.placeholder = item.placeholder || '';
    cont.appendChild(input);

    row.control.appendChild(cont);
    registerParamMeta(item.id, {type:'tags', label:item.label, unit:'', default:item.default, itemRef:item});
    return row.row;
  }

  function renderRepeater(item){
    const rep = document.createElement('div');
    rep.className = 'repeater' + (item.compact ? ' compact' : '');
    rep.dataset.repeater = item.id;
    rep.dataset.label = item.label || item.id;
    rep.dataset.columns = JSON.stringify(item.columns || []);

    const head = document.createElement('div');
    head.className = 'rep-head';
    head.innerHTML = `<span>${escapeHtml(item.label || 'Repeater')}</span>`;
    const addBtn = document.createElement('button');
    addBtn.className = 'mini rep-add';
    addBtn.textContent = 'Add';
    head.appendChild(addBtn);

    const list = document.createElement('div');
    list.className = 'rep-list';

    rep.appendChild(head);
    rep.appendChild(list);

    // Wrap in group-body row look
    const wrap = document.createElement('div');
    wrap.className = 'group-body';
    wrap.appendChild(rep);

    registerParamMeta(item.id, {type:'repeater', label:item.label, unit:'', default:item.default || [], columns:item.columns || [], itemRef:item});
    return wrap;
  }

  function renderComposite(item){
    const row = rowTemplate(item.label);
    const composite = document.createElement('div');
    composite.className = 'composite-row';
    composite.style.gridColumn = 'span 2';

    (item.items || []).forEach(sub=>{
      if (sub.type === 'input'){
        const input = document.createElement('input');
        input.type = sub.inputType || 'text';
        input.className = 'param';
        input.dataset.param = sub.id;
        input.dataset.label = sub.label || sub.id;
        if (sub.placeholder) input.placeholder = sub.placeholder;
        if (sub.min !== undefined) input.min = sub.min;
        if (sub.max !== undefined) input.max = sub.max;
        if (sub.step !== undefined) input.step = sub.step;
        composite.appendChild(input);
        registerParamMeta(sub.id, {type:'input', inputType: input.type, label:sub.label, unit:sub.unit, default:sub.default, itemRef:sub});
      }
    });

    row.control.replaceWith(composite);
    return row.row;
  }

  function rowTemplate(label){
    const row = document.createElement('div');
    row.className = 'row';
    const lab = document.createElement('div');
    lab.className = 'label'; lab.textContent = label || '';
    const ctl = document.createElement('div');
    const unit = document.createElement('div');
    unit.className = 'unit';
    row.append(lab, ctl, unit);
    return {row, control: ctl, unit};
  }

  // -------------------- Unrecognized Parameters --------------------

  function ensureUnrecognizedGroup(){
    if ($('#unrecognizedGroup')) return;
    const d = document.createElement('details');
    d.id = 'unrecognizedGroup';
    d.open = true;
    const s = document.createElement('summary');
    s.innerHTML = `<span class="triangle">▶</span> Unrecognized Parameters`;
    const body = document.createElement('div');
    body.className = 'group-body';
    d.append(s, body);
    els.paramsPanel.appendChild(d);
    d.style.display = 'none';
  }

  function addUnrecognizedParam(id, value){
    ensureUnrecognizedGroup();
    const d = $('#unrecognizedGroup');
    d.style.display = '';
    const body = d.querySelector('.group-body');

    const row = document.createElement('div');
    row.className = 'row';
    const lab = document.createElement('div');
    lab.className = 'label'; lab.textContent = id;
    const ctl = document.createElement('div');
    const ta = document.createElement('textarea');
    ta.className = 'unknown-param';
    ta.dataset.unknownId = id;
    ta.value = (typeof value === 'string' || typeof value === 'number') ? String(value) : JSON.stringify(value, null, 2);
    ctl.appendChild(ta);
    const unit = document.createElement('div');
    unit.className = 'unit';
    row.append(lab, ctl, unit);
    body.appendChild(row);
    UNKNOWN_PARAMS.set(id, value);
  }

  function clearUnrecognized(){
    UNKNOWN_PARAMS.clear();
    const d = $('#unrecognizedGroup');
    if (d){
      d.querySelector('.group-body').innerHTML = '';
      d.style.display = 'none';
    }
  }

  // -------------------- Input Hooks --------------------

  function hookToolbar(){
    // Awareness & auto-apply
    els.awareness.addEventListener('change', ()=>{
      queueChange('meta.awareness', els.awareness.value, 'Awareness');
      updateAwarenessEcho();
    });
    els.autoApply.addEventListener('change', ()=>{
      queueChange('meta.autoApply', els.autoApply.checked ? 'ON' : 'OFF', 'Auto-apply');
    });
    els.applyBtn.addEventListener('click', applyAllQueued);

    // Export/Import (subject only)
    els.exportBtn.addEventListener('click', exportSubjectFile);
    els.importBtn.addEventListener('click', ()=> els.subjectUpload.click());
    els.subjectUpload.addEventListener('change', handleImportSubjectFile);

    // Lock & expand/collapse
    els.lockBtn.addEventListener('click', toggleLock);
    els.expandAll.addEventListener('click', ()=> setAllDetails(true));
    els.collapseAll.addEventListener('click', ()=> setAllDetails(false));

    // Logs & commands
    els.clearQueueBtn.addEventListener('click', clearQueue);
    els.clearAppliedBtn.addEventListener('click', clearApplied);
    els.queueCmdBtn.addEventListener('click', queueCommand);

    // Image upload: file picker
    els.imgUpload.addEventListener('change', handleImageFileSelect);
    
    // Image upload: manual button trigger
    const imgUploadBtn = $('#imgUploadBtn');
    if (imgUploadBtn){
      imgUploadBtn.addEventListener('click', ()=> els.imgUpload.click());
    }

    // Image upload: URL
    const imgUrlBtn = $('#imgUrlBtn');
    const imgUrlInput = $('#imgUrlInput');
    if (imgUrlBtn && imgUrlInput){
      imgUrlBtn.addEventListener('click', ()=>{
        const url = (imgUrlInput.value || '').trim();
        if (url){
          setPreviewImageFromURL(url);
          imgUrlInput.value = '';
        }else{
          alert('Enter an image URL.');
        }
      });
      imgUrlInput.addEventListener('keydown', e=>{
        if (e.key === 'Enter'){
          e.preventDefault();
          imgUrlBtn.click();
        }
      });
    }

    // Image clear
    els.clearImgBtn.addEventListener('click', clearPreviewImage);

    // Drag & drop on preview area
    const previewArea = $('#preview');
    if (previewArea){
      previewArea.addEventListener('dragover', e=>{
        e.preventDefault();
        e.stopPropagation();
        previewArea.classList.add('drag-over');
      });
      previewArea.addEventListener('dragleave', e=>{
        e.preventDefault();
        e.stopPropagation();
        previewArea.classList.remove('drag-over');
      });
      previewArea.addEventListener('drop', e=>{
        e.preventDefault();
        e.stopPropagation();
        previewArea.classList.remove('drag-over');
        const files = e.dataTransfer?.files;
        if (files && files[0]){
          loadImageFromFile(files[0]);
        }
      });
    }

    // Subject modal
    els.subjectSearchBtn.addEventListener('click', openSubjectModal);
    els.modalClose.addEventListener('click', closeSubjectModal);
    els.cancelSubjectBtn.addEventListener('click', closeSubjectModal);
    els.useSubjectBtn.addEventListener('click', useSubjectFromModal);
    els.presetFilter.addEventListener('input', filterPresetList);
  }


  function handleImageFileSelect(e){
    const file = e.target.files?.[0];
    e.target.value = ''; // reset for repeat uploads
    if (file) loadImageFromFile(file);
  }

  function loadImageFromFile(file){
    const reader = new FileReader();
    reader.onload = ()=>{
      setPreviewImageFromURL(reader.result); // data URL
    };
    reader.readAsDataURL(file);
  }

  function setAllDetails(open){
    $$('#paramsPanel details').forEach(d => d.open = open);
  }

  function updateAwarenessEcho(){
    els.awarenessEcho.textContent = els.awareness.value || '—';
  }

  function toggleLock(){
    locked = !locked;
    updateLockState();
  }
  function updateLockState(){
    els.lockState.textContent = locked ? 'Locked' : 'Unlocked';
    els.lockState.style.color = locked ? 'var(--danger)' : 'var(--muted)';
    $$('#paramsPanel input, #paramsPanel select, #paramsPanel textarea, #paramsPanel button').forEach(el => el.disabled = locked);
    els.customCmd.disabled = locked;
    els.queueCmdBtn.disabled = locked;
    els.applyBtn.disabled = locked;
  }

  function hookParamInputs(){
    $$('.param').forEach(input=>{
      const label = input.dataset.label || input.dataset.param;
      if (input.type === 'range'){
        input.addEventListener('input', e=>{
          const val = String(e.target.value);
          const b = findSiblingBubble(e.target);
          if (b) b.textContent = val;
          queueParamChange(e.target, val, label);
        });
      }else if (input.type === 'color'){
        input.addEventListener('input', e=>{
          queueParamChange(e.target, e.target.value, label);
        });
      }else{
        input.addEventListener('change', e=>{
          queueParamChange(e.target, e.target.value, label);
        });
      }
    });
  }

  function hookTagInputs(){
    $$('.tag-input').forEach(container=>{
      const input = container.querySelector('input[type="text"]');
      container.addEventListener('click', ()=> input && input.focus());
      input?.addEventListener('keydown', e=>{
        if (e.key === 'Enter' && input.value.trim()){
          e.preventDefault();
          addTag(container, input.value.trim());
          input.value='';
          recordTagChange(container);
        }else if (e.key==='Backspace' && !input.value){
          const last = container.querySelector('.tag:not(.ghost):last-of-type');
          if (last){ last.remove(); recordTagChange(container); }
        }
      });
    });
  }

  function addTag(container, text){
    const tag = document.createElement('span');
    tag.className = 'tag';
    tag.textContent = text;
    const x = document.createElement('span');
    x.className = 'x'; x.textContent='×'; x.title='Remove';
    x.addEventListener('click', ()=>{ tag.remove(); recordTagChange(container); });
    tag.appendChild(x);
    const ghost = container.querySelector('.tag.ghost');
    if (ghost) ghost.remove();
    container.insertBefore(tag, container.querySelector('input'));
  }

  function recordTagChange(container){
    const id = container.dataset.param;
    const label = container.dataset.label || id;
    const tags = [...container.querySelectorAll('.tag:not(.ghost)')].map(t=>t.childNodes[0].nodeValue.trim());
    queueChange(id, tags, label);
  }

  function hookRepeaters(){
    $$('.repeater').forEach(rep=>{
      rep.querySelector('.rep-add').addEventListener('click', ()=>{
        const cols = JSON.parse(rep.dataset.columns || '[]');
        addRepeaterRow(rep, cols, {});
      });
    });
  }

  function addRepeaterRow(rep, columns, data){
    const list = rep.querySelector('.rep-list');
    const row = document.createElement('div');
    row.className = 'rep-row';
    row.style.gridTemplateColumns = columns.map(()=> '1fr').join(' ') + ' auto';

    columns.forEach(col=>{
      const wrap = document.createElement('div');
      if (col.type === 'range'){
        wrap.style.display='grid';
        wrap.style.gridTemplateColumns='1fr 50px';
        wrap.style.gap='6px';
        const r = document.createElement('input');
        r.type='range'; r.min = col.min ?? 0; r.max = col.max ?? 100; r.step = col.step ?? 1;
        r.value = Number.isFinite(Number(data[col.key])) ? data[col.key] : 0;
        const bub = document.createElement('div'); bub.className='value-bubble'; bub.textContent = r.value;
        r.addEventListener('input', ()=>{ bub.textContent=r.value; recordRepeater(rep); });
        wrap.append(r, bub);
      }else{
        const i = document.createElement('input');
        i.type='text'; i.placeholder = col.label || ''; i.value = data[col.key] ?? '';
        i.addEventListener('change', ()=> recordRepeater(rep));
        wrap.appendChild(i);
      }
      row.appendChild(wrap);
    });

    const del = document.createElement('button');
    del.className='mini danger kill'; del.textContent='Delete';
    del.addEventListener('click', ()=>{ row.remove(); recordRepeater(rep); });
    row.appendChild(del);

    list.appendChild(row);
  }

  function recordRepeater(rep){
    const id = rep.dataset.repeater;
    const label = rep.dataset.label || id;
    const columns = JSON.parse(rep.dataset.columns || '[]');
    const rows = [...rep.querySelectorAll('.rep-row')];
    const data = rows.map(r=>{
      const obj = {};
      let idx=0;
      r.querySelectorAll('input').forEach(inp=>{
        const col = columns[idx];
        if (col){
          obj[col.key] = (inp.type==='range') ? Number(inp.value) : inp.value;
        }
        idx++;
      });
      return obj;
    });
    queueChange(id, data, label);
  }

  function findSiblingBubble(rangeEl){
    const row = rangeEl.closest('.slider-row');
    return row ? row.querySelector('.value-bubble') : null;
  }

  // -------------------- Queue/Apply --------------------

  function queueParamChange(input, val, label){
    const id = input.dataset.param;
    // Convert vals for numeric inputs
    let to = val;
    if (input.type === 'number'){
      const n = parseFloat(val);
      if (!Number.isNaN(n)) to = n;
    }else if (input.type === 'range'){
      to = Number(val);
    }
    queueChange(id, to, label, input.dataset.unit);
  }

  function queueChange(id, to, label, unit){
    if (!currentSubject){
      alert('Select a subject first (Search for subjects).');
      return;
    }
    const from = currentParams.has(id) ? currentParams.get(id) : '—';
    // If unchanged remove from queue
    if (JSON.stringify(from) === JSON.stringify(to)){
      stagedChanges.delete(id);
      renderQueue();
      return;
    }
    stagedChanges.set(id, {from, to, label: label || id, unit: unit || ''});
    renderQueue();

    if (els.autoApply.checked){
      applyChange(id, from, to, label, unit);
      stagedChanges.delete(id);
      renderQueue();
    }
  }

  function applyAllQueued(){
    if (locked){ alert('Parameters are locked. Unlock to apply changes.'); return; }
    if (!stagedChanges.size){ alert('No queued changes.'); return; }
    for (const [id, ch] of stagedChanges.entries()){
      applyChange(id, ch.from, ch.to, ch.label, ch.unit);
    }
    stagedChanges.clear();
    renderQueue();
  }

  function applyChange(id, from, to, label, unit){
    currentParams.set(id, to);
    appliedLog.push({param:id, from, to, label: label || id, unit: unit || '', ts: Date.now()});
    renderApplied();
  }

  function renderQueue(){
    els.queueList.innerHTML = '';
    if (!stagedChanges.size){
      const e = document.createElement('div'); e.className='note'; e.textContent='No queued changes.';
      els.queueList.appendChild(e); return;
    }
    for (const [id, ch] of stagedChanges.entries()){
      const div = document.createElement('div'); div.className='change';
      div.innerHTML = `<span class="verb">SET</span> <span class="path">${escapeHtml(ch.label)}</span>
        <span class="from">[${escapeHtml(displayVal(ch.from, ch.unit))}]</span>
        → <span class="to">${escapeHtml(displayVal(ch.to, ch.unit))}</span>`;
      els.queueList.appendChild(div);
    }
  }

  function renderApplied(){
    els.appliedList.innerHTML = '';
    if (!appliedLog.length){
      const e = document.createElement('div'); e.className='note'; e.textContent='No applied changes yet.';
      els.appliedList.appendChild(e); return;
    }
    appliedLog.slice(-500).forEach(it=>{
      const div = document.createElement('div'); div.className='change';
      if (it.cmd){
        div.innerHTML = `<span class="verb">CMD</span> <span class="path">${escapeHtml(it.cmd)}</span>
          <span class="from ghost">@${new Date(it.ts).toLocaleTimeString()}</span>`;
      }else{
        div.innerHTML = `<span class="verb">APPLY</span> <span class="path">${escapeHtml(it.label)}</span>
          <span class="from">[${escapeHtml(displayVal(it.from, it.unit))}]</span>
          → <span class="to">${escapeHtml(displayVal(it.to, it.unit))}</span>
          <span class="from ghost">@${new Date(it.ts).toLocaleTimeString()}</span>`;
      }
      els.appliedList.appendChild(div);
    });
  }

  function clearQueue(){ stagedChanges.clear(); renderQueue(); }
  function clearApplied(){ if (confirm('Clear applied log?')) { appliedLog.length=0; renderApplied(); } }

  function queueCommand(){
    const txt = (els.customCmd.value || '').trim();
    if (!txt){ alert('Type a command.'); return; }
    if (!currentSubject){ alert('Select a subject first.'); return; }
    if (els.autoApply.checked){
      appliedLog.push({cmd: txt, ts: Date.now()}); renderApplied();
    }else{
      stagedChanges.set(`cmd.${Date.now()}`, {from:'—', to: txt, label:'Command', unit:''});
      renderQueue();
    }
    els.customCmd.value='';
  }

  function displayVal(val, unit){
    if (val === null || val === undefined) return '—';
    if (Array.isArray(val) || typeof val === 'object') return '[...]';
    if (unit) return `${val} ${unit}`;
    return String(val);
  }

  // -------------------- Defaults & Value Application --------------------

  function defaultForId(id){
    const meta = PARAM_META.get(id);
    if (!meta) return undefined;
    if (meta.default !== undefined) return meta.default;
    // sensible fallbacks by type based on DOM
    if (meta.type === 'range'){
      const el = paramInputById(id);
      if (el) return Number(el.min || 0);
      return 0;
    }
    if (meta.type === 'select'){
      const el = paramInputById(id);
      if (el && el.options && el.options.length) return el.options[0].value;
      return '';
    }
    if (meta.type === 'tags') return [];
    if (meta.type === 'repeater') return [];
    if (meta.type === 'input' && meta.inputType === 'color') return '#000000';
    return '';
  }

  function paramInputById(id){
    return document.querySelector(`.param[data-param="${cssAttr(id)}"]`);
  }

  function tagsContainerById(id){
    return document.querySelector(`.tag-input[data-param="${cssAttr(id)}"]`);
  }

  function repeaterById(id){
    return document.querySelector(`.repeater[data-repeater="${cssAttr(id)}"]`);
  }

  // set value into UI (no queuing/logging)
  function setValueSilent(id, value){
    // recognized inputs
    const inp = paramInputById(id);
    const tagCont = tagsContainerById(id);
    const rep = repeaterById(id);

    if (rep && Array.isArray(value)){
      const cols = JSON.parse(rep.dataset.columns || '[]');
      rep.querySelector('.rep-list').innerHTML = '';
      value.forEach(row => addRepeaterRow(rep, cols, row || {}));
      // update currentParams
      currentParams.set(id, value);
      return;
    }
    if (tagCont){
      // expect array or string
      tagCont.querySelectorAll('.tag:not(.ghost)').forEach(t=>t.remove());
      if (Array.isArray(value)){
        value.forEach(v => addTag(tagCont, String(v)));
      }else if (typeof value === 'string'){
        value.split(',').map(s=>s.trim()).filter(Boolean).forEach(v => addTag(tagCont, v));
      }
      currentParams.set(id, Array.isArray(value) ? value : String(value));
      return;
    }
    if (inp){
      if (inp.type === 'range'){
        const n = Number(value);
        if (!Number.isNaN(n)){
          inp.value = String(n);
          const b = findSiblingBubble(inp); if (b) b.textContent = inp.value;
          currentParams.set(id, n);
        }
      }else if (inp.type === 'number'){
        if (value === '' || value === null || value === undefined){
          inp.value = '';
          currentParams.set(id, '');
        }else{
          const n = Number(value);
          inp.value = Number.isNaN(n) ? String(value) : String(n);
          currentParams.set(id, Number.isNaN(n) ? String(value) : n);
        }
      }else{
        inp.value = String(value ?? '');
        currentParams.set(id, inp.value);
      }
      return;
    }

    // unknown ids go to Unrecognized
    addUnrecognizedParam(id, value);
  }

  function applyDefaultsForAll(){
    // recognized items
    for (const id of KNOWN_IDS){
      const def = defaultForId(id);
      setValueSilent(id, def);
    }
    // clear unknown
    clearUnrecognized();
  }

  // -------------------- Export / Import Subject (id/value pairs only) --------------------

  function exportSubjectFile(){
    if (!currentSubject){ alert('Select a subject first.'); return; }
    
    const pairs = [];

    // Recognized .param (simple inputs)
    $$('.param').forEach(el=>{
      const id = el.dataset.param;
      const meta = PARAM_META.get(id);
      if (!meta) return;
      let val;
      if (meta.type === 'range'){
        val = Number(el.value);
      }else if (meta.type === 'input' && el.type === 'number'){
        if (el.value === '') return;
        const n = Number(el.value);
        val = Number.isNaN(n) ? el.value : n;
      }else if (meta.type === 'input' && el.type === 'color'){
        val = el.value || '#000000';
      }else{
        if (el.value === '') return;
        val = el.value;
      }
      pairs.push({ id, value: val });
    });

    // Tags -> arrays
    $$('.tag-input').forEach(ti=>{
      const id = ti.dataset.param;
      const tags = [...ti.querySelectorAll('.tag:not(.ghost)')].map(t => t.childNodes[0].nodeValue.trim());
      if (tags.length) pairs.push({ id, value: tags });
    });

    // Repeaters -> arrays of objects
    $$('.repeater').forEach(rep=>{
      const id = rep.dataset.repeater;
      const cols = JSON.parse(rep.dataset.columns || '[]');
      const rows = [...rep.querySelectorAll('.rep-row')];
      if (!rows.length) return;
      const arr = rows.map(r=>{
        const obj={};
        let idx=0;
        r.querySelectorAll('input').forEach(inp=>{
          const col = cols[idx];
          if (col){
            obj[col.key] = (inp.type==='range') ? Number(inp.value) : inp.value;
          }
          idx++;
        });
        return obj;
      });
      pairs.push({ id, value: arr });
    });

    // Unknowns (textarea) -> try JSON, else string
    $$('.unknown-param').forEach(ta=>{
      const id = ta.dataset.unknownId;
      const txt = ta.value;
      let val;
      try{ val = JSON.parse(txt); }catch{ val = txt; }
      pairs.push({ id, value: val });
    });

    // Get current image (either data URL or external URL)
    let imageURL = null;
    if (els.previewImg.src && els.previewImg.style.display !== 'none'){
      imageURL = els.previewImg.src;
    }

    const out = {
      name: currentSubject,
      image: imageURL,
      values: pairs
    };

    const blob = new Blob([JSON.stringify(out, null, 2)], {type:'application/json'});
    const slug = (currentSubject || 'subject').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'') || 'subject';
    const stamp = new Date().toISOString().replace(/[:.]/g,'-');
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `subject-${slug}-${stamp}.json`;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
  }
  function handleImportSubjectFile(e){
    const file = e.target.files?.[0];
    e.target.value = '';
    if (!file) return;
    if (locked){ alert('Unlock parameters before importing.'); return; }
    
    const r = new FileReader();
    r.onload = ()=>{
      try{
        const data = JSON.parse(r.result);
        const { name, image, pairs } = normalizeSubjectData(data);
        
        // Set subject name from file if provided
        if (name){
          setCurrentSubject(name);
        } else if (!currentSubject){
          setCurrentSubject('Imported Subject');
        }

        // Import parameter values
        importPairsApply(pairs);

        // Load image if provided
        if (image){
          setPreviewImageFromURL(image);
        }

        alert('Subject values imported.');
      }catch(err){
        console.error(err);
        alert('Invalid subject.json');
      }
    };
    r.readAsText(file);
  }

  // Accepts:
  // { values: [{id, value}...] } OR
  // [ {id,value}, ... ] OR
  // { "id1": value1, "id2": value2, ... }
  function normalizeSubjectData(data){
    let pairs = [];
    let name = null;
    let image = null;

    // Extract metadata
    if (data && typeof data === 'object'){
      name = data.name || null;
      image = data.image || null;

      // Extract values
      if (Array.isArray(data.values)){
        pairs = data.values;
      } else if (Array.isArray(data)){
        pairs = data;
      } else {
        // Flat object format { "id1": value1, ... }
        pairs = Object.entries(data)
          .filter(([k]) => k !== 'name' && k !== 'image') // exclude metadata
          .map(([id, value]) => ({id, value}));
      }
    }

    return {
      name,
      image,
      pairs: pairs.filter(p => p && typeof p.id === 'string')
    };
  }

  function importPairsApply(pairs){
    // Build id->value map
    const map = new Map(pairs.map(p => [p.id, p.value]));

    // Clear unknowns
    clearUnrecognized();

    // Apply defaults for all schema ids first
    for (const id of KNOWN_IDS){
      const v = map.has(id) ? map.get(id) : defaultForId(id);
      setValueSilent(id, v);
    }

    // Any id present in file but not in schema -> unrecognized
    for (const {id, value} of pairs){
      if (!KNOWN_IDS.has(id)){
        addUnrecognizedParam(id, value);
      }
    }
  }

  // -------------------- Subject Modal --------------------

  async function loadPresetIndex(){
    try{
      const r = await fetch('subjects/index.json', {cache:'no-store'});
      if (!r.ok) throw new Error();
      const arr = await r.json();
      const list = Array.isArray(arr) ? arr : (Array.isArray(arr.subjects) ? arr.subjects : []);
      // Keep name, file, image
      PRESETS = list
        .filter(x => x && x.name && x.file)
        .map(x => ({ name: x.name, file: x.file, image: x.image || '' }));
    }catch(_){
      PRESETS = [];
    }
    rebuildPresetList();
    rebuildPresetSelect();
  }

  function openSubjectModal(){
    rebuildPresetList();
    rebuildPresetSelect();
    els.subjectNameInput.value = currentSubject || '';
    SELECTED_PRESET = null;
    els.modal.classList.remove('hidden');
  }
  function closeSubjectModal(){
    els.modal.classList.add('hidden');
  }

  function filterPresetList(){
    const q = (els.presetFilter.value || '').toLowerCase();
    $$('.preset-card').forEach(card=>{
      const name = (card.dataset.name || '').toLowerCase();
      card.style.display = name.includes(q) ? '' : 'none';
    });
  }

  function rebuildPresetList(){
    els.presetList.innerHTML = '';
    if (!PRESETS.length){
      const note = document.createElement('div');
      note.className='note';
      note.textContent = 'No predefined subjects found.';
      els.presetList.appendChild(note);
      return;
    }

    PRESETS.forEach(p=>{
      const card = document.createElement('button');
      card.className = 'preset-card';
      card.dataset.name = p.name;
      card.innerHTML = `
        <div style="display:flex; gap:10px; align-items:center;">
          ${p.image ? `<img src="${p.image}" alt="" style="width:44px;height:44px;object-fit:cover;border-radius:6px;border:1px solid var(--line);" />` : ''}
          <div style="display:flex;flex-direction:column;gap:2px;">
            <div class="pc-title">${escapeHtml(p.name)}</div>
            <div class="pc-sub">${escapeHtml(p.file)}</div>
          </div>
        </div>`;
      card.addEventListener('click', ()=>{
        SELECTED_PRESET = p;
        els.subjectNameInput.value = p.name;
        $$('.preset-card').forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');
      });
      els.presetList.appendChild(card);
    });

    filterPresetList();
  }

  function rebuildPresetSelect(){
    els.presetSelect.innerHTML = '';
    const optNone = document.createElement('option');
    optNone.value=''; optNone.textContent='— Select preset —';
    els.presetSelect.appendChild(optNone);
    PRESETS.forEach(p=>{
      const op = document.createElement('option');
      op.value = p.file; op.textContent = p.name;
      els.presetSelect.appendChild(op);
    });
  }

  async function useSubjectFromModal(){
    const name = (els.subjectNameInput.value || '').trim();
    if (!name){ alert('Enter a subject name or pick one.'); return; }

    const mode = (document.querySelector('input[name="newMode"]:checked')?.value) || 'blank';
    const presetFileFromSelect = els.presetSelect.value || '';

    // If user clicked a preset card
    if (SELECTED_PRESET){
      await setCurrentSubjectAndLoad(name, SELECTED_PRESET.file, SELECTED_PRESET.image);
      closeSubjectModal();
      return;
    }

    // If user chose "Start from preset" from dropdown
    if (mode === 'preset' && presetFileFromSelect){
      const preset = PRESETS.find(p => p.file === presetFileFromSelect);
      const presetImg = preset?.image || '';
      await setCurrentSubjectAndLoad(name, presetFileFromSelect, presetImg);
    }else{
      // Blank subject: apply defaults and clear preview
      setCurrentSubject(name);
      applyDefaultsForAll();
      clearUnrecognized();
      clearPreviewImage();
    }

    closeSubjectModal();
  }

  async function setCurrentSubjectAndLoad(name, file, imageUrl){
    // Set the user-chosen name FIRST, before loading the file
    setCurrentSubject(name);

    try{
      const r = await fetch(file, {cache:'no-store'});
      if (!r.ok) throw new Error(`Failed to load ${file}`);
      const data = await r.json();
      const { image: subjectImage, pairs } = normalizeSubjectData(data);
      // Note: we ignore subjectName from the file here

      // Import parameters
      importPairsApply(pairs);

      // Use image from file if available, otherwise use provided imageUrl
      const finalImage = subjectImage || imageUrl;
      if (finalImage){
        setPreviewImageFromURL(finalImage);
      } else {
        clearPreviewImage();
      }
    }catch(err){
      console.error(err);
      alert(err.message || 'Failed to load preset.');
      applyDefaultsForAll();
      clearPreviewImage();
    }
  }

  function setCurrentSubject(name){
    currentSubject = name;
    els.subjectNameHeader.textContent = name || 'None';
    els.previewBadge.textContent = name || 'No Subject';
    // reset queues and logs for new subject context
    stagedChanges.clear();
    renderQueue();
    // don't clear applied log to keep session history, but we can if desired
  }

  function setPreviewImageFromURL(url){
    if (!url) { clearPreviewImage(); return; }
    els.previewImg.onload = () => { els.previewImg.style.display='block'; els.previewPh.style.display='none'; els.previewImg.onload = null; };
    els.previewImg.onerror = () => { console.warn('Failed to load subject image:', url); clearPreviewImage(); els.previewImg.onerror = null; };
    els.previewImg.src = url;
  }

  function clearPreviewImage(){
    els.previewImg.src = '';
    els.previewImg.style.display = 'none';
    els.previewPh.style.display = 'block';
  }

  // -------------------- Utilities --------------------

  function cssAttr(s){ return String(s).replace(/["\\]/g, '\\$&'); }
  function escapeHtml(s){
    return String(s).replace(/[&<>"'`]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'}[c]));
  }

  // -------------------- Resizers (same approach as before) --------------------

  function installResizers(){
    const grid = document.querySelector('.grid');
    const footer = document.querySelector('.footer');
    const header = document.querySelector('.header');
    const app = document.querySelector('.app');
    if (!grid || !footer || !header || !app) return;

    // Vars ensure defaults
    if (!getComputedStyle(document.documentElement).getPropertyValue('--col-left')) document.documentElement.style.setProperty('--col-left','360px');
    if (!getComputedStyle(document.documentElement).getPropertyValue('--footer-h')) document.documentElement.style.setProperty('--footer-h','240px');
    if (!getComputedStyle(document.documentElement).getPropertyValue('--logs-left-px')) document.documentElement.style.setProperty('--logs-left-px','50%');

    // vertical between left/right
    const vMain = document.createElement('div'); vMain.className='resizer resizer-col'; grid.appendChild(vMain);
    makeDrag(vMain, {
      onStart(){ return { leftPx: pxVar('--col-left', 360) }; },
      onMove(dx){ const rect = grid.getBoundingClientRect();
        const minLeft=240, minRight=360;
        let newLeft = pxVar('--col-left', 360) + dx;
        newLeft = Math.max(minLeft, Math.min(newLeft, rect.width - 12 - minRight));
        setCssVar('--col-left', newLeft+'px');
      }
    });

    // horizontal between grid/footer
    const hMain = document.createElement('div'); hMain.className='resizer resizer-row'; footer.appendChild(hMain);
    makeDrag(hMain, {
      onStart(){ return { footerH: pxVar('--footer-h', 240) }; },
      onMove(dx, dy, start){ const appRect = app.getBoundingClientRect();
        const headerH = header.getBoundingClientRect().height;
        const minFooter = 140;
        const maxFooter = Math.max(minFooter, appRect.height - headerH - 220);
        let newH = start.footerH - dy;
        newH = Math.max(minFooter, Math.min(newH, maxFooter));
        setCssVar('--footer-h', newH+'px');
      }
    });

    // vertical between logs
    const vLogs = document.createElement('div'); vLogs.className='resizer resizer-col-logs'; footer.appendChild(vLogs);
    makeDrag(vLogs, {
      onStart(){ return { leftPx: logsLeftPixels(footer) }; },
      onMove(dx){ const rect = footer.getBoundingClientRect();
        const min=260; let newLeft = logsLeftPixels(footer) + dx;
        newLeft = Math.max(min, Math.min(newLeft, rect.width - 12 - min));
        setCssVar('--logs-left-px', newLeft+'px');
      }
    });

    window.addEventListener('resize', ()=>{
      const rect = grid.getBoundingClientRect();
      const left = pxVar('--col-left',360);
      const clampedLeft = Math.max(240, Math.min(left, rect.width - 12 - 360));
      if (clampedLeft!==left) setCssVar('--col-left', clampedLeft+'px');

      const fRect = footer.getBoundingClientRect();
      const logsLeft = logsLeftPixels(footer);
      const clampedLogsLeft = Math.max(260, Math.min(logsLeft, fRect.width - 12 - 260));
      if (clampedLogsLeft!==logsLeft) setCssVar('--logs-left-px', clampedLogsLeft+'px');
    });
  }

  function makeDrag(handle, {onStart, onMove}){
    handle.addEventListener('pointerdown', e=>{
      e.preventDefault();
      handle.setPointerCapture?.(e.pointerId);
      const start = onStart ? onStart() : {};
      const sx = e.clientX, sy = e.clientY;
      function move(ev){ onMove?.(ev.clientX - sx, ev.clientY - sy, start); }
      function up(){
        document.removeEventListener('pointermove', move);
        document.removeEventListener('pointerup', up);
        document.body.style.userSelect='';
        document.body.style.cursor='';
      }
      document.addEventListener('pointermove', move);
      document.addEventListener('pointerup', up, {once:true});
      document.body.style.userSelect='none';
      document.body.style.cursor = getComputedStyle(handle).cursor || 'default';
    });
  }
  function setCssVar(name, value){ document.documentElement.style.setProperty(name, value); }
  function pxVar(name, fallback){
    const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    if (!v) return fallback;
    if (v.endsWith('px')) return parseFloat(v);
    const n = parseFloat(v);
    return Number.isFinite(n) ? n : fallback;
  }
  function logsLeftPixels(footerEl){
    const raw = getComputedStyle(document.documentElement).getPropertyValue('--logs-left-px').trim();
    if (raw.endsWith('px')) return parseFloat(raw);
    const firstLog = footerEl.querySelector('.log');
    return firstLog ? firstLog.getBoundingClientRect().width : (footerEl.getBoundingClientRect().width/2);
  }

})();
</script>
</body>
</html>